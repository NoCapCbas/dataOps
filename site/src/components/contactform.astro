---
import Button from "./ui/button.astro";
---

<!-- Multi-step contact form â€” submits to Web3Forms -->
<form
  action="https://api.web3forms.com/submit"
  method="POST"
  id="form"
  class="needs-validation"
  novalidate>
  <input type="hidden" name="access_key" value="966a1b76-6bd7-4805-bbff-cce91f22de51" />
  <input type="checkbox" class="hidden" style="display:none" name="botcheck" />

  <!-- Progress indicator -->
  <div class="flex items-center justify-between mb-8">
    <div class="flex items-center gap-2" id="step-indicators">
      <div class="step-dot active w-8 h-8 rounded-full bg-black text-white text-sm flex items-center justify-center font-medium" data-step="1">1</div>
      <div class="w-8 h-0.5 bg-gray-300 transition-colors duration-300" id="bar-1"></div>
      <div class="step-dot w-8 h-8 rounded-full bg-gray-200 text-gray-500 text-sm flex items-center justify-center font-medium" data-step="2">2</div>
      <div class="w-8 h-0.5 bg-gray-300 transition-colors duration-300" id="bar-2"></div>
      <div class="step-dot w-8 h-8 rounded-full bg-gray-200 text-gray-500 text-sm flex items-center justify-center font-medium" data-step="3">3</div>
    </div>
    <span class="text-sm text-slate-400" id="step-label">Step 1 of 3</span>
  </div>

  <!-- Step 1: Data source -->
  <div id="step-1" class="form-step">
    <label class="block text-sm font-medium text-gray-700 mb-2">What website do you need data from?</label>
    <div class="mb-5">
      <input
        type="text"
        placeholder="e.g. linkedin.com, amazon.com, zillow.com"
        required
        class="w-full px-4 py-3 border-2 placeholder:text-gray-400 rounded-md outline-none focus:ring-4 border-gray-300 focus:border-gray-600 ring-gray-100"
        name="source"
        id="source-input"
      />
      <div class="empty-feedback invalid-feedback text-red-400 text-sm mt-1">
        Please enter a website or data source.
      </div>
    </div>
    <Button type="button" size="lg" block class="step-next" data-next="2">Next</Button>
  </div>

  <!-- Step 2: Data type & frequency -->
  <div id="step-2" class="form-step hidden">
    <label class="block text-sm font-medium text-gray-700 mb-2">What data do you need from it?</label>
    <div class="mb-5 grid grid-cols-2 gap-2">
      <label class="flex items-center gap-2 px-4 py-3 border-2 rounded-md cursor-pointer hover:border-gray-600 transition-colors has-[:checked]:border-black has-[:checked]:bg-gray-50">
        <input type="checkbox" name="data_type" value="contacts" class="accent-black" />
        <span class="text-sm text-gray-800">Contact info / leads</span>
      </label>
      <label class="flex items-center gap-2 px-4 py-3 border-2 rounded-md cursor-pointer hover:border-gray-600 transition-colors has-[:checked]:border-black has-[:checked]:bg-gray-50">
        <input type="checkbox" name="data_type" value="products" class="accent-black" />
        <span class="text-sm text-gray-800">Products / prices</span>
      </label>
      <label class="flex items-center gap-2 px-4 py-3 border-2 rounded-md cursor-pointer hover:border-gray-600 transition-colors has-[:checked]:border-black has-[:checked]:bg-gray-50">
        <input type="checkbox" name="data_type" value="reviews" class="accent-black" />
        <span class="text-sm text-gray-800">Reviews / ratings</span>
      </label>
      <label class="flex items-center gap-2 px-4 py-3 border-2 rounded-md cursor-pointer hover:border-gray-600 transition-colors has-[:checked]:border-black has-[:checked]:bg-gray-50">
        <input type="checkbox" name="data_type" value="jobs" class="accent-black" />
        <span class="text-sm text-gray-800">Job postings</span>
      </label>
      <label class="flex items-center gap-2 px-4 py-3 border-2 rounded-md cursor-pointer hover:border-gray-600 transition-colors has-[:checked]:border-black has-[:checked]:bg-gray-50 col-span-2">
        <input type="checkbox" name="data_type" value="other" class="accent-black" />
        <span class="text-sm text-gray-800">Other</span>
      </label>
    </div>
    <div class="empty-feedback invalid-feedback text-red-400 text-sm mb-3 hidden" id="data-type-error">
      Please select at least one data type.
    </div>

    <label class="block text-sm font-medium text-gray-700 mb-2">How often do you need this data?</label>
    <div class="mb-5 grid grid-cols-2 gap-2">
      <label class="flex items-center gap-2 px-4 py-3 border-2 rounded-md cursor-pointer hover:border-gray-600 transition-colors has-[:checked]:border-black has-[:checked]:bg-gray-50">
        <input type="radio" name="frequency" value="one-time" class="accent-black" />
        <span class="text-sm text-gray-800">One-time pull</span>
      </label>
      <label class="flex items-center gap-2 px-4 py-3 border-2 rounded-md cursor-pointer hover:border-gray-600 transition-colors has-[:checked]:border-black has-[:checked]:bg-gray-50">
        <input type="radio" name="frequency" value="daily" class="accent-black" />
        <span class="text-sm text-gray-800">Daily</span>
      </label>
      <label class="flex items-center gap-2 px-4 py-3 border-2 rounded-md cursor-pointer hover:border-gray-600 transition-colors has-[:checked]:border-black has-[:checked]:bg-gray-50">
        <input type="radio" name="frequency" value="weekly" class="accent-black" />
        <span class="text-sm text-gray-800">Weekly</span>
      </label>
      <label class="flex items-center gap-2 px-4 py-3 border-2 rounded-md cursor-pointer hover:border-gray-600 transition-colors has-[:checked]:border-black has-[:checked]:bg-gray-50">
        <input type="radio" name="frequency" value="monthly" class="accent-black" />
        <span class="text-sm text-gray-800">Monthly</span>
      </label>
    </div>
    <div class="empty-feedback invalid-feedback text-red-400 text-sm mb-3 hidden" id="frequency-error">
      Please select a frequency.
    </div>

    <div class="flex gap-3">
      <button type="button" class="step-back px-6 py-3 border-2 border-black rounded text-black hover:bg-black hover:text-white transition w-full" data-back="1">Back</button>
      <Button type="button" size="lg" block class="step-next" data-next="3">Next</Button>
    </div>
  </div>

  <!-- Step 3: Contact info -->
  <div id="step-3" class="form-step hidden">
    <label class="block text-sm font-medium text-gray-700 mb-2">Where should we send your free sample?</label>
    <div class="mb-5">
      <input
        type="email"
        placeholder="Email address"
        name="email"
        required
        id="email-input"
        class="w-full px-4 py-3 border-2 placeholder:text-gray-400 rounded-md outline-none focus:ring-4 border-gray-300 focus:border-gray-600 ring-gray-100"
      />
      <div class="empty-feedback text-red-400 text-sm mt-1">
        Please provide your email address.
      </div>
      <div class="invalid-feedback text-red-400 text-sm mt-1">
        Please provide a valid email address.
      </div>
    </div>
    <div class="mb-5">
      <input
        type="text"
        placeholder="Your name"
        name="name"
        required
        id="name-input"
        class="w-full px-4 py-3 border-2 placeholder:text-gray-400 rounded-md outline-none focus:ring-4 border-gray-300 focus:border-gray-600 ring-gray-100"
      />
      <div class="empty-feedback invalid-feedback text-red-400 text-sm mt-1">
        Please provide your name.
      </div>
    </div>
    <div class="flex gap-3">
      <button type="button" class="step-back px-6 py-3 border-2 border-black rounded text-black hover:bg-black hover:text-white transition w-full" data-back="2">Back</button>
      <Button type="submit" size="lg" block>Get My Free Sample</Button>
    </div>
    <p class="text-xs text-slate-400 mt-3 text-center">We'll send your sample within 24 hours.</p>
  </div>

  <div id="result" class="mt-3 text-center"></div>
</form>

<div id="toast" class="fixed bottom-6 right-6 z-50 hidden transform transition-all duration-300 translate-y-4 opacity-0">
  <div class="px-6 py-4 rounded-lg shadow-lg text-white text-sm font-medium max-w-sm">
    <span id="toast-message"></span>
  </div>
</div>

<style>
  .invalid-feedback,
  .empty-feedback {
    display: none;
  }

  .was-validated :placeholder-shown:invalid ~ .empty-feedback {
    display: block;
  }

  .was-validated :not(:placeholder-shown):invalid ~ .invalid-feedback {
    display: block;
  }

  .is-invalid,
  .was-validated :invalid {
    border-color: #dc3545;
  }

  .form-step {
    animation: fadeIn 0.3s ease-in-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateX(10px); }
    to { opacity: 1; transform: translateX(0); }
  }
</style>

<script is:inline>
  const form = document.getElementById("form");
  const submitBtn = form.querySelector('button[type="submit"]');
  const toast = document.getElementById("toast");
  const toastMessage = document.getElementById("toast-message");
  const steps = form.querySelectorAll(".form-step");
  const stepDots = form.querySelectorAll(".step-dot");
  const stepLabel = document.getElementById("step-label");
  let currentStep = 1;

  function showStep(n) {
    steps.forEach((s) => s.classList.add("hidden"));
    document.getElementById("step-" + n).classList.remove("hidden");

    stepDots.forEach((dot, i) => {
      const stepNum = i + 1;
      if (stepNum <= n) {
        dot.classList.add("bg-black", "text-white");
        dot.classList.remove("bg-gray-200", "text-gray-500");
      } else {
        dot.classList.remove("bg-black", "text-white");
        dot.classList.add("bg-gray-200", "text-gray-500");
      }
    });

    // Update progress bars
    document.getElementById("bar-1").style.backgroundColor = n >= 2 ? "#000" : "";
    document.getElementById("bar-2").style.backgroundColor = n >= 3 ? "#000" : "";

    stepLabel.textContent = "Step " + n + " of 3";
    currentStep = n;

    // Remove validation state when navigating
    form.classList.remove("was-validated");
  }

  function validateStep(n) {
    if (n === 1) {
      const source = document.getElementById("source-input");
      if (!source.value.trim()) {
        form.classList.add("was-validated");
        source.focus();
        return false;
      }
    }
    if (n === 2) {
      const checked = form.querySelectorAll('input[name="data_type"]:checked');
      const freq = form.querySelector('input[name="frequency"]:checked');
      const typeError = document.getElementById("data-type-error");
      const freqError = document.getElementById("frequency-error");

      typeError.classList.add("hidden");
      freqError.classList.add("hidden");

      if (checked.length === 0) {
        typeError.classList.remove("hidden");
        return false;
      }
      if (!freq) {
        freqError.classList.remove("hidden");
        return false;
      }
    }
    return true;
  }

  // Next buttons
  form.querySelectorAll(".step-next").forEach((btn) => {
    btn.addEventListener("click", () => {
      const next = parseInt(btn.dataset.next);
      if (validateStep(currentStep)) {
        showStep(next);
      }
    });
  });

  // Back buttons
  form.querySelectorAll(".step-back").forEach((btn) => {
    btn.addEventListener("click", () => {
      showStep(parseInt(btn.dataset.back));
    });
  });

  function showToast(message, type) {
    toastMessage.textContent = message;
    toast.querySelector("div").className =
      "px-6 py-4 rounded-lg shadow-lg text-white text-sm font-medium max-w-sm " +
      (type === "success" ? "bg-green-600" : "bg-red-600");
    toast.classList.remove("hidden");
    requestAnimationFrame(() => {
      toast.classList.remove("translate-y-4", "opacity-0");
      toast.classList.add("translate-y-0", "opacity-100");
    });
    setTimeout(() => {
      toast.classList.remove("translate-y-0", "opacity-100");
      toast.classList.add("translate-y-4", "opacity-0");
      setTimeout(() => toast.classList.add("hidden"), 300);
    }, 4000);
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    form.classList.add("was-validated");

    // Validate step 3 fields
    const email = document.getElementById("email-input");
    const name = document.getElementById("name-input");
    if (!email.value.trim() || !email.checkValidity() || !name.value.trim()) {
      const firstInvalid = form.querySelector("#step-3 :invalid");
      if (firstInvalid) firstInvalid.focus();
      return;
    }

    const formData = new FormData(form);

    // Combine checkbox values into readable string
    const dataTypes = Array.from(form.querySelectorAll('input[name="data_type"]:checked'))
      .map((cb) => cb.value)
      .join(", ");
    formData.set("data_type", dataTypes);

    const originalText = submitBtn.textContent;
    submitBtn.textContent = "Sending...";
    submitBtn.disabled = true;

    try {
      const response = await fetch("https://api.web3forms.com/submit", {
        method: "POST",
        body: formData,
      });

      const data = await response.json();

      if (response.ok) {
        showToast("Success! We'll send your sample within 24 hours.", "success");
        form.reset();
        form.classList.remove("was-validated");
        showStep(1);
      } else {
        showToast("Error: " + data.message, "error");
      }
    } catch (error) {
      showToast("Something went wrong. Please try again.", "error");
    } finally {
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
    }
  });
</script>
